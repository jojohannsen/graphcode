<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Graph Visualization System</title>
    
    <!-- Prism CSS for syntax highlighting -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet" />
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #0a0a0a;
            color: #e0e0e0;
            height: 100vh;
            overflow: hidden;
        }
        
        .container {
            display: grid;
            grid-template-columns: 2fr 1fr 3fr;
            height: 100vh;
            gap: 1px;
            background-color: #2a2a2a;
        }
        
        .column {
            background-color: #1a1a1a;
            overflow-y: auto;
            padding: 20px;
        }
        
        /* First column - Graph display */
        .graph-column {
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 14px;
            line-height: 1.6;
            position: relative;
            padding: 0;
            display: flex;
            flex-direction: column;
        }
        
        .graph-header {
            background-color: #2d3142;
            color: #e8e9eb;
            padding: 8px 20px;
            font-size: 13px;
            font-weight: 500;
            border-bottom: 1px solid #3a3d4e;
            min-height: 36px;
            display: flex;
            align-items: center;
            flex-shrink: 0;
        }
        
        .graph-content-wrapper {
            padding: 20px;
            flex-grow: 1;
            overflow-y: auto;
        }
        
        .file-list {
            display: block;
        }
        
        .graph-display {
            display: none;
        }
        
        .file-item {
            padding: 8px 12px;
            margin: 4px 0;
            background-color: #252525;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s;
            color: #b0b0b0;
        }
        
        .file-item:hover {
            background-color: #353535;
            color: #ffffff;
        }
        
        .close-button {
            position: absolute;
            top: 10px;
            right: 15px;
            background: none;
            border: none;
            color: #666;
            font-size: 18px;
            cursor: pointer;
            padding: 4px;
            border-radius: 3px;
            transition: all 0.2s;
        }
        
        .close-button:hover {
            background-color: #2a2a2a;
            color: #ccc;
        }
        
        .graph-line {
            margin: 2px 0;
            padding: 4px 8px;
            border-radius: 3px;
            transition: background-color 0.2s;
        }
        
        .graph-line:hover {
            background-color: #2a2a2a;
        }
        
        .graph-comment {
            color: #6a9955;
            font-style: italic;
        }
        
        .graph-state {
            color: #569cd6;
            font-weight: bold;
        }
        
        .graph-node {
            color: #9cdcfe;
        }
        
        .graph-arrow {
            color: #d4d4d4;
        }
        
        .graph-end {
            color: #ce9178;
            font-weight: bold;
        }
        
        /* Second column - Navigation */
        .nav-column {
            border-left: 1px solid #2a2a2a;
            border-right: 1px solid #2a2a2a;
        }
        
        .nav-link {
            display: block;
            padding: 12px 16px;
            margin: 4px 0;
            text-decoration: none;
            color: #b0b0b0;
            background-color: #252525;
            border-radius: 6px;
            transition: all 0.3s ease;
            font-size: 14px;
            cursor: pointer;
        }
        
        .nav-link:hover:not(.disabled) {
            background-color: #353535;
            color: #ffffff;
            transform: translateX(4px);
        }
        
        .nav-link.active {
            background-color: #2a4e7d;
            color: #ffffff;
        }
        
        .nav-link.disabled {
            opacity: 0.4;
            cursor: not-allowed;
            background-color: #1d1d1d;
            color: #606060;
        }
        
        .nav-link.disabled:hover {
            transform: none;
        }
        
        /* Third column - Content display */
        .content-column {
            position: relative;
        }
        
        .content-header {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #3a3a3a;
            color: #ffffff;
        }
        
        .content-body {
            font-size: 14px;
            line-height: 1.8;
        }
        
        /* Markdown styling */
        .markdown-content h1, .markdown-content h2, .markdown-content h3 {
            margin: 20px 0 10px 0;
            color: #ffffff;
        }
        
        .markdown-content h1 {
            font-size: 28px;
            border-bottom: 2px solid #3a3a3a;
            padding-bottom: 8px;
        }
        
        .markdown-content h2 {
            font-size: 22px;
        }
        
        .markdown-content p {
            margin: 12px 0;
        }
        
        .markdown-content code {
            background-color: #2a2a2a;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 13px;
        }
        
        .markdown-content pre {
            background-color: #2a2a2a;
            padding: 16px;
            border-radius: 6px;
            overflow-x: auto;
            margin: 16px 0;
        }
        
        .markdown-content ul, .markdown-content ol {
            margin: 12px 0;
            padding-left: 24px;
        }
        
        .markdown-content li {
            margin: 6px 0;
        }
        
        /* Code block styling */
        pre[class*="language-"] {
            background-color: #2a2a2a;
            border-radius: 6px;
            padding: 16px;
            margin: 0;
        }
        
        /* Loading indicator */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            font-size: 16px;
            color: #666;
        }
        
        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: #1a1a1a;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #3a3a3a;
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #4a4a4a;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- First column: Graph/File List -->
        <div class="column graph-column" id="graphColumn">
            <div class="graph-header" id="graphHeader" style="display: none;">
                <span id="selectedFileName"></span>
            </div>
            <div class="graph-content-wrapper">
                <div class="file-list" id="fileList">
                    <div class="loading">Loading files...</div>
                </div>
                <div class="graph-display" id="graphDisplay">
                    <button class="close-button" id="closeGraph" title="Close and return to file list">âœ•</button>
                    <div id="graphContent"></div>
                </div>
            </div>
        </div>
        
        <!-- Second column: Navigation -->
        <div class="column nav-column">
            <nav style="padding-top: 20px;">
                <a href="#" class="nav-link disabled" data-file="state_spec">state spec</a>
                <a href="#" class="nav-link disabled" data-file="state_code">state code</a>
                <a href="#" class="nav-link disabled" data-file="node_spec">node spec</a>
                <a href="#" class="nav-link disabled" data-file="node_code">node code</a>
                <a href="#" class="nav-link disabled" data-file="graph_definition">graph definition</a>
                <a href="#" class="nav-link disabled" data-file="main">main</a>
            </nav>
        </div>
        
        <!-- Third column: Content Display -->
        <div class="column content-column">
            <h2 class="content-header" id="contentHeader">Welcome</h2>
            <div class="content-body" id="contentBody">
                <p>Select a file from the navigation menu to view its contents.</p>
            </div>
        </div>
    </div>
    
    <!-- Prism JS for syntax highlighting -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>
    
    <!-- Marked JS for markdown rendering -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.3.0/marked.min.js"></script>
    
    <script>
        // Parse and display graph with color coding
        function parseGraph(graphContent) {
            const lines = graphContent.split('\n');
            const graphContent_div = document.getElementById('graphContent');
            graphContent_div.innerHTML = '';
            
            lines.forEach(line => {
                const lineDiv = document.createElement('div');
                lineDiv.className = 'graph-line';
                
                if (line.trim().startsWith('#')) {
                    // Comment
                    lineDiv.innerHTML = `<span class="graph-comment">${line}</span>`;
                } else if (line.includes('->')) {
                    // Connection
                    const parts = line.split('->');
                    const source = parts[0].trim();
                    const target = parts[1].trim();
                    
                    let sourceClass = 'graph-node';
                    let targetClass = 'graph-node';
                    
                    if (source === 'State') sourceClass = 'graph-state';
                    if (target === 'END') targetClass = 'graph-end';
                    
                    lineDiv.innerHTML = `<span class="${sourceClass}">${source}</span> <span class="graph-arrow">-></span> <span class="${targetClass}">${target}</span>`;
                } else if (line.trim()) {
                    // Other content
                    lineDiv.textContent = line;
                }
                
                if (line.trim()) {
                    graphContent_div.appendChild(lineDiv);
                }
            });
        }
        
        // Load and display txt files
        async function loadTxtFiles() {
            try {
                const response = await fetch('/api/txt-files');
                const data = await response.json();
                const fileList = document.getElementById('fileList');
                
                if (data.files.length === 0) {
                    fileList.innerHTML = '<div style="color: #666; text-align: center; padding: 20px;">No .txt files found in the current directory</div>';
                    return;
                }
                
                fileList.innerHTML = '';
                data.files.forEach(filename => {
                    const fileItem = document.createElement('div');
                    fileItem.className = 'file-item';
                    fileItem.textContent = filename;
                    fileItem.addEventListener('click', () => loadGraphFromFile(filename));
                    fileList.appendChild(fileItem);
                });
            } catch (error) {
                console.error('Error loading txt files:', error);
                document.getElementById('fileList').innerHTML = '<div style="color: #ff6b6b; text-align: center; padding: 20px;">Error loading files</div>';
            }
        }
        
        // Track current loaded file
        let currentLoadedFile = null;
        
        // Load graph from specific file
        async function loadGraphFromFile(filename) {
            try {
                const response = await fetch(`/api/graph/${filename}`);
                const data = await response.json();
                
                if (data.error) {
                    alert(`Error loading file: ${data.error}`);
                    return;
                }
                
                // Store current file
                currentLoadedFile = filename;
                
                // Switch to graph display
                document.getElementById('fileList').style.display = 'none';
                document.getElementById('graphDisplay').style.display = 'block';
                
                // Show header with filename
                const fileNameWithoutExt = filename.replace('.txt', '');
                document.getElementById('selectedFileName').textContent = fileNameWithoutExt;
                document.getElementById('graphHeader').style.display = 'flex';
                
                // Enable only the state spec button
                document.querySelectorAll('.nav-link').forEach(link => {
                    link.classList.add('disabled');
                });
                const stateSpecLink = document.querySelector('[data-file="state_spec"]');
                stateSpecLink.classList.remove('disabled');
                
                parseGraph(data.content);
            } catch (error) {
                console.error('Error loading graph:', error);
                alert('Error loading graph file');
            }
        }
        
        // Show file list and hide graph
        function showFileList() {
            document.getElementById('fileList').style.display = 'block';
            document.getElementById('graphDisplay').style.display = 'none';
            document.getElementById('graphHeader').style.display = 'none';
            
            // Clear current file
            currentLoadedFile = null;
            
            // Disable all navigation links
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.add('disabled');
                link.classList.remove('active');
            });
            
            // Reset content area
            document.getElementById('contentHeader').textContent = 'Welcome';
            document.getElementById('contentBody').innerHTML = '<p>Select a file from the navigation menu to view its contents.</p>';
        }
        
        // Initialize close button
        function initializeCloseButton() {
            document.getElementById('closeGraph').addEventListener('click', showFileList);
        }
        
        // Generate state spec
        async function generateStateSpec() {
            if (!currentLoadedFile) {
                alert('No file loaded');
                return;
            }
            
            const contentBody = document.getElementById('contentBody');
            contentBody.innerHTML = '<div class="loading">Generating state specification...</div>';
            
            try {
                const response = await fetch('/api/generate/state-spec', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ filename: currentLoadedFile })
                });
                
                const data = await response.json();
                
                if (data.error) {
                    contentBody.innerHTML = `<div class="loading">Error: ${data.error}</div>`;
                    return;
                }
                
                // Display the generated markdown
                contentBody.innerHTML = `<div class="markdown-content">${marked.parse(data.content)}</div>`;
                
                // Enable the state code button
                const stateCodeLink = document.querySelector('[data-file="state_code"]');
                stateCodeLink.classList.remove('disabled');
                
            } catch (error) {
                console.error('Error generating state spec:', error);
                contentBody.innerHTML = '<div class="loading">Error generating state specification</div>';
            }
        }
        
        // Handle navigation clicks
        document.querySelectorAll('.nav-link').forEach(link => {
            link.addEventListener('click', async (e) => {
                e.preventDefault();
                
                // Check if link is disabled
                if (link.classList.contains('disabled')) {
                    return;
                }
                
                // Update active state
                document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
                link.classList.add('active');
                
                const fileKey = link.dataset.file;
                const fileName = link.textContent;
                
                // Update header
                document.getElementById('contentHeader').textContent = fileName;
                
                // Special handling for state spec
                if (fileKey === 'state_spec' && currentLoadedFile) {
                    await generateStateSpec();
                    return;
                }
                
                // Show loading
                document.getElementById('contentBody').innerHTML = '<div class="loading">Loading...</div>';
                
                try {
                    const response = await fetch(`/api/file/${fileKey}`);
                    const data = await response.json();
                    
                    const contentBody = document.getElementById('contentBody');
                    
                    if (fileKey.includes('spec')) {
                        // Render markdown
                        contentBody.innerHTML = `<div class="markdown-content">${marked.parse(data.content)}</div>`;
                    } else {
                        // Render Python code with syntax highlighting
                        contentBody.innerHTML = `<pre><code class="language-python">${data.content}</code></pre>`;
                        Prism.highlightAll();
                    }
                } catch (error) {
                    console.error('Error loading file:', error);
                    document.getElementById('contentBody').innerHTML = '<div class="loading">Error loading file</div>';
                }
            });
        });
        
        // Initialize the application
        loadTxtFiles();
        initializeCloseButton();
    </script>
</body>
</html>
