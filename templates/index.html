<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Graph Visualization System</title>
    
    <!-- Prism CSS for syntax highlighting -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet" />
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #0a0a0a;
            color: #e0e0e0;
            height: 100vh;
            overflow: hidden;
        }
        
        .container {
            display: grid;
            grid-template-columns: 2fr 1fr 3fr;
            height: 100vh;
            gap: 1px;
            background-color: #2a2a2a;
        }
        
        .column {
            background-color: #1a1a1a;
            overflow-y: auto;
            padding: 20px;
        }
        
        /* First column - Graph display */
        .graph-column {
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 14px;
            line-height: 1.6;
            position: relative;
            padding: 0;
            display: flex;
            flex-direction: column;
        }
        
        .graph-header {
            background-color: #2d3142;
            color: #e8e9eb;
            padding: 8px 20px;
            font-size: 13px;
            font-weight: 500;
            border-bottom: 1px solid #3a3d4e;
            min-height: 36px;
            display: flex;
            align-items: center;
            flex-shrink: 0;
        }
        
        .graph-content-wrapper {
            padding: 20px;
            flex-grow: 1;
            overflow-y: auto;
        }
        
        .file-list {
            display: block;
        }
        
        .graph-display {
            display: none;
        }
        
        .file-item {
            padding: 8px 12px;
            margin: 4px 0;
            background-color: #252525;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s;
            color: #b0b0b0;
        }
        
        .file-item:hover {
            background-color: #353535;
            color: #ffffff;
        }
        
        .graph-header-buttons {
            position: absolute;
            top: 10px;
            right: 15px;
            display: flex;
            gap: 8px;
        }
        
        .header-button {
            background: none;
            border: none;
            color: #666;
            font-size: 16px;
            cursor: pointer;
            padding: 4px;
            border-radius: 3px;
            transition: all 0.2s;
        }
        
        .header-button:hover {
            background-color: #2a2a2a;
            color: #ccc;
        }
        
        .header-button.edit-button:hover {
            color: #ccc;
        }
        
        .graph-line {
            margin: 2px 0;
            padding: 4px 8px;
            border-radius: 3px;
            transition: background-color 0.2s;
        }
        
        .graph-line:hover {
            background-color: #2a2a2a;
        }
        
        .graph-comment {
            color: #6a9955;
            font-style: italic;
        }
        
        .graph-state {
            color: #569cd6;
            font-weight: bold;
        }
        
        .graph-node {
            color: #9cdcfe;
        }
        
        .graph-arrow {
            color: #d4d4d4;
        }
        
        .graph-end {
            color: #ce9178;
            font-weight: bold;
        }
        
        /* Second column - Navigation */
        .nav-column {
            border-left: 1px solid #2a2a2a;
            border-right: 1px solid #2a2a2a;
        }
        
        .nav-link {
            display: block;
            padding: 12px 16px;
            margin: 4px 0;
            text-decoration: none;
            color: #b0b0b0;
            background-color: #252525;
            border-radius: 6px;
            transition: all 0.3s ease;
            font-size: 14px;
            cursor: pointer;
        }
        
        .nav-link:hover:not(.disabled) {
            background-color: #353535;
            color: #ffffff;
            transform: translateX(4px);
        }
        
        .nav-link.active {
            background-color: #2a4e7d;
            color: #ffffff;
        }
        
        .nav-link.disabled {
            opacity: 0.4;
            cursor: not-allowed;
            background-color: #1d1d1d;
            color: #606060;
        }
        
        .nav-link.disabled:hover {
            transform: none;
        }
        
        /* Third column - Content display */
        .content-column {
            position: relative;
            display: flex;
            flex-direction: column;
        }
        
        .content-header {
            background-color: #2d3142;
            color: #e8e9eb;
            padding: 8px 20px;
            font-size: 13px;
            font-weight: 500;
            border-bottom: 1px solid #3a3d4e;
            min-height: 36px;
            display: flex;
            align-items: center;
            flex-shrink: 0;
            margin: 0;
            justify-content: space-between;
        }
        
        .content-header.welcome-style {
            background-color: #1a1a1a;
            color: #ffffff;
            font-size: 20px;
            font-weight: 600;
            padding: 20px;
            border-bottom: 1px solid #3a3a3a;
        }
        
        .content-body-wrapper {
            padding: 20px;
            flex-grow: 1;
            overflow-y: auto;
            position: relative;
        }
        
        .delete-button {
            background: none;
            border: none;
            color: #666;
            font-size: 16px;
            cursor: pointer;
            padding: 4px;
            border-radius: 3px;
            transition: all 0.2s;
            margin-left: auto;
            display: none;
        }
        
        .delete-button:hover {
            background-color: #2a2a2a;
            color: #ff6b6b;
        }
        
        .delete-button.visible {
            display: block;
        }
        
        .content-body {
            font-size: 14px;
            line-height: 1.8;
        }
        
        /* Markdown styling */
        .markdown-content h1, .markdown-content h2, .markdown-content h3 {
            margin: 20px 0 10px 0;
            color: #ffffff;
        }
        
        .markdown-content h1 {
            font-size: 28px;
            border-bottom: 2px solid #3a3a3a;
            padding-bottom: 8px;
        }
        
        .markdown-content h2 {
            font-size: 22px;
        }
        
        .markdown-content p {
            margin: 12px 0;
        }
        
        .markdown-content code {
            background-color: #2a2a2a;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 13px;
        }
        
        .markdown-content pre {
            background-color: #2a2a2a;
            padding: 16px;
            border-radius: 6px;
            overflow-x: auto;
            margin: 16px 0;
        }
        
        .markdown-content ul, .markdown-content ol {
            margin: 12px 0;
            padding-left: 24px;
        }
        
        .markdown-content li {
            margin: 6px 0;
        }
        
        /* Code block styling */
        pre[class*="language-"] {
            background-color: #2a2a2a;
            border-radius: 6px;
            padding: 16px;
            margin: 0;
        }
        
        /* Loading indicator */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            font-size: 16px;
            color: #666;
        }
        
        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: #1a1a1a;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #3a3a3a;
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #4a4a4a;
        }
        
        /* Modal styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        
        .modal-overlay.show {
            opacity: 1;
            visibility: visible;
        }
        
        .modal {
            background-color: #2d3142;
            border-radius: 12px;
            padding: 0;
            min-width: 400px;
            max-width: 500px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            transform: scale(0.7) translateY(-20px);
            transition: all 0.3s ease;
            border: 1px solid #3a3d4e;
        }
        
        .modal-overlay.show .modal {
            transform: scale(1) translateY(0);
        }
        
        .modal-header {
            padding: 24px 24px 16px 24px;
            border-bottom: 1px solid #3a3d4e;
        }
        
        .modal-title {
            font-size: 18px;
            font-weight: 600;
            color: #ffffff;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .modal-icon {
            font-size: 20px;
            color: #ff6b6b;
        }
        
        .modal-body {
            padding: 20px 24px;
        }
        
        .modal-message {
            color: #e0e0e0;
            font-size: 14px;
            line-height: 1.5;
            margin: 0;
        }
        
        .modal-filename {
            color: #9cdcfe;
            font-family: 'Consolas', 'Monaco', monospace;
            font-weight: 500;
        }
        
        .modal-footer {
            padding: 16px 24px 24px 24px;
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }
        
        .modal-button {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            min-width: 80px;
        }
        
        .modal-button-cancel {
            background-color: #3a3d4e;
            color: #e0e0e0;
        }
        
        .modal-button-cancel:hover {
            background-color: #4a4d5e;
        }
        
        .modal-button-delete {
            background-color: #ff6b6b;
            color: #ffffff;
        }
        
        .modal-button-delete:hover {
            background-color: #ff5252;
        }
        
        .modal-button:focus {
            outline: 2px solid #569cd6;
            outline-offset: 2px;
        }
        
        /* Edit mode styles */
        .editor-container {
            display: none;
            position: relative;
            width: 100%;
            margin-bottom: 12px;
        }
        
        .editor-container.show {
            display: block;
        }
        
        .graph-editor {
            width: 100%;
            height: 400px;
            background-color: transparent;
            color: transparent;
            border: 1px solid #3a3a3a;
            border-radius: 4px;
            padding: 12px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 14px;
            line-height: 1.6;
            resize: vertical;
            outline: none;
            position: relative;
            z-index: 2;
            caret-color: #e0e0e0;
        }
        
        .graph-editor:focus {
            border-color: #569cd6;
        }
        
        .editor-highlight {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #1e1e1e;
            border: 1px solid transparent;
            border-radius: 4px;
            padding: 12px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 14px;
            line-height: 1.6;
            pointer-events: none;
            z-index: 1;
            white-space: pre-wrap;
            word-wrap: break-word;
            overflow: hidden;
        }
        
        .edit-controls {
            display: none;
            gap: 12px;
            justify-content: flex-end;
            padding: 8px 0;
        }
        
        .edit-controls.show {
            display: flex;
        }
        
        .edit-button-control {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .save-button-control {
            background-color: #4caf50;
            color: #ffffff;
        }
        
        .save-button-control:hover {
            background-color: #66bb6a;
        }
        
        .cancel-button-control {
            background-color: #3a3d4e;
            color: #e0e0e0;
        }
        
        .cancel-button-control:hover {
            background-color: #4a4d5e;
        }
        
        #graphContent.edit-mode {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- First column: Graph/File List -->
        <div class="column graph-column" id="graphColumn">
            <div class="graph-header" id="graphHeader" style="display: none;">
                <span id="selectedFileName"></span>
            </div>
            <div class="graph-content-wrapper">
                <div class="file-list" id="fileList">
                    <div class="loading">Loading files...</div>
                </div>
                <div class="graph-display" id="graphDisplay">
                    <div class="graph-header-buttons">
                        <button class="header-button edit-button" id="editGraph" title="Edit graph content">✎</button>
                        <button class="header-button" id="closeGraph" title="Close and return to file list">✕</button>
                    </div>
                    <div id="graphContent"></div>
                    <div class="editor-container" id="editorContainer">
                        <div class="editor-highlight" id="editorHighlight"></div>
                        <textarea class="graph-editor" id="graphEditor" placeholder="Enter graph content here..."></textarea>
                    </div>
                    <div class="edit-controls" id="editControls">
                        <button class="edit-button-control cancel-button-control" id="cancelEdit">Cancel</button>
                        <button class="edit-button-control save-button-control" id="saveGraph">Save</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Second column: Navigation -->
        <div class="column nav-column">
            <nav style="padding-top: 20px;">
                <a href="#" class="nav-link disabled" data-file="state_spec">state spec</a>
                <a href="#" class="nav-link disabled" data-file="state_code">state code</a>
                <a href="#" class="nav-link disabled" data-file="node_spec">node spec</a>
                <a href="#" class="nav-link disabled" data-file="node_code">node code</a>
                <a href="#" class="nav-link disabled" data-file="graph_code">graph code</a>
                <a href="#" class="nav-link disabled" data-file="main">main</a>
            </nav>
        </div>
        
        <!-- Third column: Content Display -->
        <div class="column content-column">
            <div class="content-header welcome-style" id="contentHeader">
                <span>Welcome</span>
                <button class="delete-button" id="deleteButton" title="Delete this file">🗑️</button>
            </div>
            <div class="content-body-wrapper">
                <div class="content-body" id="contentBody">
                    <p>Select a file from the navigation menu to view its contents.</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Confirm Delete Modal -->
    <div class="modal-overlay" id="confirmModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">
                    <span class="modal-icon">⚠️</span>
                    Confirm Delete
                </h3>
            </div>
            <div class="modal-body">
                <p class="modal-message">
                    Are you sure you want to delete <span class="modal-filename" id="modalFilename"></span>?
                    <br><br>
                    This action cannot be undone.
                </p>
            </div>
            <div class="modal-footer">
                <button class="modal-button modal-button-cancel" id="modalCancel">Cancel</button>
                <button class="modal-button modal-button-delete" id="modalConfirm">Delete</button>
            </div>
        </div>
    </div>
    
    <!-- Confirm Save Modal -->
    <div class="modal-overlay" id="confirmSaveModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">
                    <span class="modal-icon">💾</span>
                    Confirm Save
                </h3>
            </div>
            <div class="modal-body">
                <p class="modal-message">
                    Are you sure you want to save changes to <span class="modal-filename" id="saveModalFilename"></span>?
                    <br><br>
                    This will overwrite the original file.
                </p>
            </div>
            <div class="modal-footer">
                <button class="modal-button modal-button-cancel" id="saveModalCancel">Cancel</button>
                <button class="modal-button modal-button-delete" id="saveModalConfirm">Save</button>
            </div>
        </div>
    </div>
    
    <!-- Prism JS for syntax highlighting -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>
    
    <!-- Marked JS for markdown rendering -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.3.0/marked.min.js"></script>
    
    <script>
        // Parse and display graph with color coding
        function parseGraph(graphContent) {
            const lines = graphContent.split('\n');
            const graphContent_div = document.getElementById('graphContent');
            graphContent_div.innerHTML = '';
            
            lines.forEach(line => {
                const lineDiv = document.createElement('div');
                lineDiv.className = 'graph-line';
                
                if (line.trim().startsWith('#')) {
                    // Comment
                    lineDiv.innerHTML = `<span class="graph-comment">${line}</span>`;
                } else if (line.includes('->')) {
                    // Connection
                    const parts = line.split('->');
                    const source = parts[0].trim();
                    const target = parts[1].trim();
                    
                    let sourceClass = 'graph-node';
                    let targetClass = 'graph-node';
                    
                    if (source === 'State') sourceClass = 'graph-state';
                    if (target === 'END') targetClass = 'graph-end';
                    
                    lineDiv.innerHTML = `<span class="${sourceClass}">${source}</span> <span class="graph-arrow">-></span> <span class="${targetClass}">${target}</span>`;
                } else if (line.trim()) {
                    // Other content
                    lineDiv.textContent = line;
                }
                
                if (line.trim()) {
                    graphContent_div.appendChild(lineDiv);
                }
            });
        }
        
        // Apply syntax highlighting to editor
        function highlightEditorContent(content) {
            const lines = content.split('\n');
            let highlighted = '';
            
            lines.forEach((line, index) => {
                if (index > 0) highlighted += '\n';
                
                if (line.trim().startsWith('#')) {
                    // Comment
                    highlighted += `<span class="graph-comment">${escapeHtml(line)}</span>`;
                } else if (line.includes('->')) {
                    // Connection
                    const parts = line.split('->');
                    const source = parts[0].trim();
                    const target = parts[1].trim();
                    const beforeSource = line.substring(0, line.indexOf(source));
                    const afterTarget = line.substring(line.indexOf(target) + target.length);
                    
                    let sourceClass = 'graph-node';
                    let targetClass = 'graph-node';
                    
                    if (source === 'State') sourceClass = 'graph-state';
                    if (target === 'END') targetClass = 'graph-end';
                    
                    highlighted += `${escapeHtml(beforeSource)}<span class="${sourceClass}">${escapeHtml(source)}</span> <span class="graph-arrow">-></span> <span class="${targetClass}">${escapeHtml(target)}</span>${escapeHtml(afterTarget)}`;
                } else {
                    // Other content
                    highlighted += escapeHtml(line);
                }
            });
            
            return highlighted;
        }
        
        // Escape HTML characters
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // Update editor highlighting
        function updateEditorHighlight() {
            const editor = document.getElementById('graphEditor');
            const highlight = document.getElementById('editorHighlight');
            const content = editor.value;
            
            highlight.innerHTML = highlightEditorContent(content);
            
            // Sync scroll position
            highlight.scrollTop = editor.scrollTop;
            highlight.scrollLeft = editor.scrollLeft;
        }
        
        // Load and display txt files
        async function loadTxtFiles() {
            try {
                const response = await fetch('/api/txt-files');
                const data = await response.json();
                const fileList = document.getElementById('fileList');
                
                if (data.files.length === 0) {
                    fileList.innerHTML = '<div style="color: #666; text-align: center; padding: 20px;">No .txt files found in the current directory</div>';
                    return;
                }
                
                fileList.innerHTML = '';
                data.files.forEach(filename => {
                    const fileItem = document.createElement('div');
                    fileItem.className = 'file-item';
                    fileItem.textContent = filename;
                    fileItem.addEventListener('click', () => loadGraphFromFile(filename));
                    fileList.appendChild(fileItem);
                });
            } catch (error) {
                console.error('Error loading txt files:', error);
                document.getElementById('fileList').innerHTML = '<div style="color: #ff6b6b; text-align: center; padding: 20px;">Error loading files</div>';
            }
        }
        
        // Track current loaded file and displayed artifact
        let currentLoadedFile = null;
        let currentDisplayedArtifact = null;
        let isEditMode = false;
        let originalGraphContent = '';
        
        // Check which files exist for a given graph name
        async function checkExistingFiles(graphName) {
            const fileChecks = {
                state_spec: `${graphName}/state-spec.md`,
                state_code: `${graphName}/state_code.py`, 
                node_spec: `${graphName}/node-spec.md`,
                node_code: `${graphName}/node_code.py`,
                graph_code: `${graphName}/graph_code.py`,
                main: `${graphName}/main.py`
            };
            
            const existingFiles = {};
            
            for (const [key, filePath] of Object.entries(fileChecks)) {
                try {
                    const response = await fetch(`/api/check-file/${filePath}`);
                    existingFiles[key] = response.ok;
                } catch (error) {
                    existingFiles[key] = false;
                }
            }
            
            return existingFiles;
        }
        
        // Update button states based on file dependencies
        function updateButtonStates(existingFiles) {
            const buttons = {
                state_spec: document.querySelector('[data-file="state_spec"]'),
                state_code: document.querySelector('[data-file="state_code"]'),
                node_spec: document.querySelector('[data-file="node_spec"]'),
                node_code: document.querySelector('[data-file="node_code"]'),
                graph_code: document.querySelector('[data-file="graph_code"]'),
                main: document.querySelector('[data-file="main"]')
            };
            
            // Reset all buttons to disabled
            Object.values(buttons).forEach(button => {
                button.classList.add('disabled');
                button.classList.remove('active');
            });
            
            // State spec is always enabled when a file is loaded
            buttons.state_spec.classList.remove('disabled');
            
            // State code enabled if state spec exists
            if (existingFiles.state_spec) {
                buttons.state_code.classList.remove('disabled');
            }
            
            // Node spec enabled if state code button is enabled and state_code.py exists
            if (!buttons.state_code.classList.contains('disabled') && existingFiles.state_code) {
                buttons.node_spec.classList.remove('disabled');
            }
            
            // Node code enabled if node spec button is enabled and node-spec.md exists
            if (!buttons.node_spec.classList.contains('disabled') && existingFiles.node_spec) {
                buttons.node_code.classList.remove('disabled');
            }
            
            // Graph code enabled if node code button is enabled and node_code.py exists
            if (!buttons.node_code.classList.contains('disabled') && existingFiles.node_code) {
                buttons.graph_code.classList.remove('disabled');
            }
            
            // Main enabled if graph code button is enabled and graph_code.py exists
            if (!buttons.graph_code.classList.contains('disabled') && existingFiles.graph_code) {
                buttons.main.classList.remove('disabled');
            }
        }
        
        // Load graph from specific file
        async function loadGraphFromFile(filename) {
            try {
                const response = await fetch(`/api/graph/${filename}`);
                const data = await response.json();
                
                if (data.error) {
                    alert(`Error loading file: ${data.error}`);
                    return;
                }
                
                // Store current file and content
                currentLoadedFile = filename;
                originalGraphContent = data.content;
                
                // Switch to graph display
                document.getElementById('fileList').style.display = 'none';
                document.getElementById('graphDisplay').style.display = 'block';
                
                // Show header with filename
                const fileNameWithoutExt = filename.replace('.txt', '');
                document.getElementById('selectedFileName').textContent = fileNameWithoutExt;
                document.getElementById('graphHeader').style.display = 'flex';
                
                // Check existing files and update button states
                const existingFiles = await checkExistingFiles(fileNameWithoutExt);
                updateButtonStates(existingFiles);
                
                parseGraph(data.content);
            } catch (error) {
                console.error('Error loading graph:', error);
                alert('Error loading graph file');
            }
        }
        
        // Show file list and hide graph
        function showFileList() {
            document.getElementById('fileList').style.display = 'block';
            document.getElementById('graphDisplay').style.display = 'none';
            document.getElementById('graphHeader').style.display = 'none';
            
            // Clear current file
            currentLoadedFile = null;
            
            // Disable all navigation links
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.add('disabled');
                link.classList.remove('active');
            });
            
            // Reset content area with welcome style
            const contentHeader = document.getElementById('contentHeader');
            contentHeader.innerHTML = '<span>Welcome</span><button class="delete-button" id="deleteButton" title="Delete this file">🗑️</button>';
            contentHeader.className = 'content-header welcome-style';
            document.getElementById('contentBody').innerHTML = '<p>Select a file from the navigation menu to view its contents.</p>';
            hideDeleteButton();
        }
        
        // Initialize close button
        function initializeCloseButton() {
            document.getElementById('closeGraph').addEventListener('click', showFileList);
        }
        
        // Enter edit mode
        function enterEditMode() {
            if (isEditMode) return;
            
            isEditMode = true;
            
            // Show editor with current content
            const editor = document.getElementById('graphEditor');
            const editorContainer = document.getElementById('editorContainer');
            
            editor.value = originalGraphContent;
            editorContainer.classList.add('show');
            
            // Initial highlighting
            updateEditorHighlight();
            
            // Hide graph display and show edit controls
            document.getElementById('graphContent').classList.add('edit-mode');
            document.getElementById('editControls').classList.add('show');
            
            // Hide edit button
            document.getElementById('editGraph').style.display = 'none';
            
            // Disable all navigation buttons
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.add('disabled');
                link.style.pointerEvents = 'none';
                link.style.opacity = '0.3';
            });
            
            // Add event listeners for real-time highlighting
            editor.addEventListener('input', updateEditorHighlight);
            editor.addEventListener('scroll', updateEditorHighlight);
            
            // Focus the editor
            editor.focus();
        }
        
        // Exit edit mode
        function exitEditMode(saveChanges = false) {
            if (!isEditMode) return;
            
            const editor = document.getElementById('graphEditor');
            const editorContainer = document.getElementById('editorContainer');
            
            if (saveChanges) {
                // Update graph content with edited content
                originalGraphContent = editor.value;
                parseGraph(originalGraphContent);
            }
            
            isEditMode = false;
            
            // Remove event listeners
            editor.removeEventListener('input', updateEditorHighlight);
            editor.removeEventListener('scroll', updateEditorHighlight);
            
            // Hide editor and edit controls
            editorContainer.classList.remove('show');
            document.getElementById('editControls').classList.remove('show');
            
            // Show graph display and edit button
            document.getElementById('graphContent').classList.remove('edit-mode');
            document.getElementById('editGraph').style.display = 'block';
            
            // Re-enable navigation buttons (with proper state checking)
            if (currentLoadedFile) {
                const fileNameWithoutExt = currentLoadedFile.replace('.txt', '');
                checkExistingFiles(fileNameWithoutExt).then(existingFiles => {
                    updateButtonStates(existingFiles);
                    // Remove the edit-mode specific styling
                    document.querySelectorAll('.nav-link').forEach(link => {
                        link.style.pointerEvents = '';
                        link.style.opacity = '';
                    });
                });
            }
        }
        
        // Show save confirmation modal
        function showSaveConfirmModal(fileName, onConfirm) {
            const modal = document.getElementById('confirmSaveModal');
            const modalFilename = document.getElementById('saveModalFilename');
            
            modalFilename.textContent = fileName;
            modal.classList.add('show');
            
            // Handle confirm button
            const confirmButton = document.getElementById('saveModalConfirm');
            const cancelButton = document.getElementById('saveModalCancel');
            
            const handleConfirm = () => {
                hideSaveConfirmModal();
                onConfirm();
                confirmButton.removeEventListener('click', handleConfirm);
                cancelButton.removeEventListener('click', handleCancel);
            };
            
            const handleCancel = () => {
                hideSaveConfirmModal();
                confirmButton.removeEventListener('click', handleConfirm);
                cancelButton.removeEventListener('click', handleCancel);
            };
            
            confirmButton.addEventListener('click', handleConfirm);
            cancelButton.addEventListener('click', handleCancel);
            
            // Close on overlay click
            const handleOverlayClick = (e) => {
                if (e.target === modal) {
                    handleCancel();
                    modal.removeEventListener('click', handleOverlayClick);
                }
            };
            modal.addEventListener('click', handleOverlayClick);
            
            // Close on Escape key
            const handleEscape = (e) => {
                if (e.key === 'Escape') {
                    handleCancel();
                    document.removeEventListener('keydown', handleEscape);
                }
            };
            document.addEventListener('keydown', handleEscape);
        }
        
        // Hide save confirmation modal
        function hideSaveConfirmModal() {
            const modal = document.getElementById('confirmSaveModal');
            modal.classList.remove('show');
        }
        
        // Save graph changes
        async function saveGraphChanges() {
            if (!currentLoadedFile) {
                alert('No file loaded');
                return;
            }
            
            const editor = document.getElementById('graphEditor');
            const newContent = editor.value;
            
            showSaveConfirmModal(currentLoadedFile, async () => {
                try {
                    const response = await fetch(`/api/save-file/${currentLoadedFile}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ content: newContent })
                    });
                    
                    const data = await response.json();
                    
                    if (data.error) {
                        alert(`Error saving file: ${data.error}`);
                        return;
                    }
                    
                    // Exit edit mode and update display
                    exitEditMode(true);
                    
                    // Show success message (optional)
                    console.log('File saved successfully');
                    
                } catch (error) {
                    console.error('Error saving file:', error);
                    alert('Error saving file');
                }
            });
        }
        
        // Generate state spec
        async function generateStateSpec() {
            if (!currentLoadedFile) {
                alert('No file loaded');
                return;
            }
            
            const contentBody = document.getElementById('contentBody');
            contentBody.innerHTML = '<div class="loading">Generating state specification...</div>';
            
            try {
                const response = await fetch('/api/generate/state-spec', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ filename: currentLoadedFile })
                });
                
                const data = await response.json();
                
                if (data.error) {
                    contentBody.innerHTML = `<div class="loading">Error: ${data.error}</div>`;
                    return;
                }
                
                // Display the generated markdown
                contentBody.innerHTML = `<div class="markdown-content">${marked.parse(data.content)}</div>`;
                
                // Show delete button and track current artifact
                const fileNameWithoutExt = currentLoadedFile.replace('.txt', '');
                currentDisplayedArtifact = `${fileNameWithoutExt}/state-spec.md`;
                showDeleteButton();
                
                // Refresh button states after successful generation
                const existingFiles = await checkExistingFiles(fileNameWithoutExt);
                updateButtonStates(existingFiles);
                
            } catch (error) {
                console.error('Error generating state spec:', error);
                contentBody.innerHTML = '<div class="loading">Error generating state specification</div>';
                hideDeleteButton();
            }
        }
        
        // Generate state code
        async function generateStateCode() {
            if (!currentLoadedFile) {
                alert('No file loaded');
                return;
            }
            
            const contentBody = document.getElementById('contentBody');
            contentBody.innerHTML = '<div class="loading">Generating state code...</div>';
            
            try {
                const response = await fetch('/api/generate/state-code', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ filename: currentLoadedFile })
                });
                
                const data = await response.json();
                
                if (data.error) {
                    contentBody.innerHTML = `<div class="loading">Error: ${data.error}</div>`;
                    return;
                }
                
                // Display the generated Python code with syntax highlighting
                contentBody.innerHTML = `<pre><code class="language-python">${data.content}</code></pre>`;
                Prism.highlightAll();
                
                // Show delete button and track current artifact
                const fileNameWithoutExt = currentLoadedFile.replace('.txt', '');
                currentDisplayedArtifact = `${fileNameWithoutExt}/state_code.py`;
                showDeleteButton();
                
                // Refresh button states after successful generation
                const existingFiles = await checkExistingFiles(fileNameWithoutExt);
                updateButtonStates(existingFiles);
                
            } catch (error) {
                console.error('Error generating state code:', error);
                contentBody.innerHTML = '<div class="loading">Error generating state code</div>';
                hideDeleteButton();
            }
        }
        
        // Generate node spec
        async function generateNodeSpec() {
            if (!currentLoadedFile) {
                alert('No file loaded');
                return;
            }
            
            const contentBody = document.getElementById('contentBody');
            contentBody.innerHTML = '<div class="loading">Generating node specification...</div>';
            
            try {
                const response = await fetch('/api/generate/node-spec', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ filename: currentLoadedFile })
                });
                
                const data = await response.json();
                
                if (data.error) {
                    contentBody.innerHTML = `<div class="loading">Error: ${data.error}</div>`;
                    return;
                }
                
                // Display the generated markdown
                contentBody.innerHTML = `<div class="markdown-content">${marked.parse(data.content)}</div>`;
                
                // Show delete button and track current artifact
                const fileNameWithoutExt = currentLoadedFile.replace('.txt', '');
                currentDisplayedArtifact = `${fileNameWithoutExt}/node-spec.md`;
                showDeleteButton();
                
                // Refresh button states after successful generation
                const existingFiles = await checkExistingFiles(fileNameWithoutExt);
                updateButtonStates(existingFiles);
                
            } catch (error) {
                console.error('Error generating node spec:', error);
                contentBody.innerHTML = '<div class="loading">Error generating node specification</div>';
                hideDeleteButton();
            }
        }
        
        // Generate node code
        async function generateNodeCode() {
            if (!currentLoadedFile) {
                alert('No file loaded');
                return;
            }
            
            const contentBody = document.getElementById('contentBody');
            contentBody.innerHTML = '<div class="loading">Generating node code...</div>';
            
            try {
                const response = await fetch('/api/generate/node-code', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ filename: currentLoadedFile })
                });
                
                const data = await response.json();
                
                if (data.error) {
                    contentBody.innerHTML = `<div class="loading">Error: ${data.error}</div>`;
                    return;
                }
                
                // Display the generated Python code with syntax highlighting
                contentBody.innerHTML = `<pre><code class="language-python">${data.content}</code></pre>`;
                Prism.highlightAll();
                
                // Show delete button and track current artifact
                const fileNameWithoutExt = currentLoadedFile.replace('.txt', '');
                currentDisplayedArtifact = `${fileNameWithoutExt}/node_code.py`;
                showDeleteButton();
                
                // Refresh button states after successful generation
                const existingFiles = await checkExistingFiles(fileNameWithoutExt);
                updateButtonStates(existingFiles);
                
            } catch (error) {
                console.error('Error generating node code:', error);
                contentBody.innerHTML = '<div class="loading">Error generating node code</div>';
                hideDeleteButton();
            }
        }
        
        // Generate graph code
        async function generateGraphCode() {
            if (!currentLoadedFile) {
                alert('No file loaded');
                return;
            }
            
            const contentBody = document.getElementById('contentBody');
            contentBody.innerHTML = '<div class="loading">Generating graph code...</div>';
            
            try {
                const response = await fetch('/api/generate/graph-code', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ filename: currentLoadedFile })
                });
                
                const data = await response.json();
                
                if (data.error) {
                    contentBody.innerHTML = `<div class="loading">Error: ${data.error}</div>`;
                    return;
                }
                
                // Display the generated Python code with syntax highlighting
                contentBody.innerHTML = `<pre><code class="language-python">${data.content}</code></pre>`;
                Prism.highlightAll();
                
                // Show delete button and track current artifact
                const fileNameWithoutExt = currentLoadedFile.replace('.txt', '');
                currentDisplayedArtifact = `${fileNameWithoutExt}/graph_code.py`;
                showDeleteButton();
                
                // Refresh button states after successful generation
                const existingFiles = await checkExistingFiles(fileNameWithoutExt);
                updateButtonStates(existingFiles);
                
            } catch (error) {
                console.error('Error generating graph code:', error);
                contentBody.innerHTML = '<div class="loading">Error generating graph code</div>';
                hideDeleteButton();
            }
        }
        
        // Generate main code
        async function generateMain() {
            if (!currentLoadedFile) {
                alert('No file loaded');
                return;
            }
            
            const contentBody = document.getElementById('contentBody');
            contentBody.innerHTML = '<div class="loading">Generating main code...</div>';
            
            try {
                const response = await fetch('/api/generate/main', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ filename: currentLoadedFile })
                });
                
                const data = await response.json();
                
                if (data.error) {
                    contentBody.innerHTML = `<div class="loading">Error: ${data.error}</div>`;
                    return;
                }
                
                // Display the generated Python code with syntax highlighting
                contentBody.innerHTML = `<pre><code class="language-python">${data.content}</code></pre>`;
                Prism.highlightAll();
                
                // Show delete button and track current artifact
                const fileNameWithoutExt = currentLoadedFile.replace('.txt', '');
                currentDisplayedArtifact = `${fileNameWithoutExt}/main.py`;
                showDeleteButton();
                
                // Refresh button states after successful generation (though main is the last step)
                const existingFiles = await checkExistingFiles(fileNameWithoutExt);
                updateButtonStates(existingFiles);
                
            } catch (error) {
                console.error('Error generating main code:', error);
                contentBody.innerHTML = '<div class="loading">Error generating main code</div>';
                hideDeleteButton();
            }
        }
        
        // Display existing file content
        async function displayExistingFile(filePath, isMarkdown = false) {
            const contentBody = document.getElementById('contentBody');
            contentBody.innerHTML = '<div class="loading">Loading existing file...</div>';
            
            try {
                const response = await fetch(`/api/get-file/${filePath}`);
                const data = await response.json();
                
                if (data.error) {
                    contentBody.innerHTML = `<div class="loading">Error: ${data.error}</div>`;
                    hideDeleteButton();
                    return false;
                }
                
                if (isMarkdown) {
                    // Display markdown content
                    contentBody.innerHTML = `<div class="markdown-content">${marked.parse(data.content)}</div>`;
                } else {
                    // Display Python code with syntax highlighting
                    contentBody.innerHTML = `<pre><code class="language-python">${data.content}</code></pre>`;
                    Prism.highlightAll();
                }
                
                // Show delete button and track current artifact
                currentDisplayedArtifact = filePath;
                showDeleteButton();
                
                return true;
            } catch (error) {
                console.error('Error loading existing file:', error);
                contentBody.innerHTML = '<div class="loading">Error loading existing file</div>';
                hideDeleteButton();
                return false;
            }
        }
        
        // Show delete button
        function showDeleteButton() {
            document.getElementById('deleteButton').classList.add('visible');
        }
        
        // Hide delete button
        function hideDeleteButton() {
            document.getElementById('deleteButton').classList.remove('visible');
            currentDisplayedArtifact = null;
        }
        
        // Show confirm modal
        function showConfirmModal(fileName, onConfirm) {
            const modal = document.getElementById('confirmModal');
            const modalFilename = document.getElementById('modalFilename');
            
            modalFilename.textContent = fileName;
            modal.classList.add('show');
            
            // Handle confirm button
            const confirmButton = document.getElementById('modalConfirm');
            const cancelButton = document.getElementById('modalCancel');
            
            const handleConfirm = () => {
                hideConfirmModal();
                onConfirm();
                confirmButton.removeEventListener('click', handleConfirm);
                cancelButton.removeEventListener('click', handleCancel);
            };
            
            const handleCancel = () => {
                hideConfirmModal();
                confirmButton.removeEventListener('click', handleConfirm);
                cancelButton.removeEventListener('click', handleCancel);
            };
            
            confirmButton.addEventListener('click', handleConfirm);
            cancelButton.addEventListener('click', handleCancel);
            
            // Close on overlay click
            const handleOverlayClick = (e) => {
                if (e.target === modal) {
                    handleCancel();
                    modal.removeEventListener('click', handleOverlayClick);
                }
            };
            modal.addEventListener('click', handleOverlayClick);
            
            // Close on Escape key
            const handleEscape = (e) => {
                if (e.key === 'Escape') {
                    handleCancel();
                    document.removeEventListener('keydown', handleEscape);
                }
            };
            document.addEventListener('keydown', handleEscape);
        }
        
        // Hide confirm modal
        function hideConfirmModal() {
            const modal = document.getElementById('confirmModal');
            modal.classList.remove('show');
        }
        
        // Delete current artifact
        async function deleteCurrentArtifact() {
            if (!currentDisplayedArtifact) {
                return;
            }
            
            const fileName = currentDisplayedArtifact.split('/').pop();
            
            showConfirmModal(fileName, async () => {
                try {
                    const response = await fetch(`/api/delete-file/${currentDisplayedArtifact}`, {
                        method: 'DELETE'
                    });
                    
                    const data = await response.json();
                    
                    if (data.error) {
                        alert(`Error deleting file: ${data.error}`);
                        return;
                    }
                    
                    // Update UI after successful deletion
                    const contentBody = document.getElementById('contentBody');
                    contentBody.innerHTML = `<div style="text-align: center; padding: 40px; color: #888;">
                        <p>File '${fileName}' has been deleted.</p>
                        <p>Click the corresponding button to regenerate it.</p>
                    </div>`;
                    
                    hideDeleteButton();
                    
                    // Refresh button states
                    if (currentLoadedFile) {
                        const fileNameWithoutExt = currentLoadedFile.replace('.txt', '');
                        const existingFiles = await checkExistingFiles(fileNameWithoutExt);
                        updateButtonStates(existingFiles);
                    }
                    
                } catch (error) {
                    console.error('Error deleting file:', error);
                    alert('Error deleting file');
                }
            });
        }
        
        // Handle navigation clicks
        document.querySelectorAll('.nav-link').forEach(link => {
            link.addEventListener('click', async (e) => {
                e.preventDefault();
                
                // Check if link is disabled
                if (link.classList.contains('disabled')) {
                    return;
                }
                
                // Update active state
                document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
                link.classList.add('active');
                
                const fileKey = link.dataset.file;
                const fileName = link.textContent;
                
                // Update header with file-loaded style
                const contentHeader = document.getElementById('contentHeader');
                contentHeader.innerHTML = `<span>${fileName}</span><button class="delete-button" id="deleteButton" title="Delete this file">🗑️</button>`;
                contentHeader.className = 'content-header';
                
                // Special handling for files that can be generated
                if (currentLoadedFile) {
                    const fileNameWithoutExt = currentLoadedFile.replace('.txt', '');
                    
                    // Define file mappings
                    const fileMapping = {
                        'state_spec': { path: `${fileNameWithoutExt}/state-spec.md`, isMarkdown: true, generateFunc: generateStateSpec },
                        'state_code': { path: `${fileNameWithoutExt}/state_code.py`, isMarkdown: false, generateFunc: generateStateCode },
                        'node_spec': { path: `${fileNameWithoutExt}/node-spec.md`, isMarkdown: true, generateFunc: generateNodeSpec },
                        'node_code': { path: `${fileNameWithoutExt}/node_code.py`, isMarkdown: false, generateFunc: generateNodeCode },
                        'graph_code': { path: `${fileNameWithoutExt}/graph_code.py`, isMarkdown: false, generateFunc: generateGraphCode },
                        'main': { path: `${fileNameWithoutExt}/main.py`, isMarkdown: false, generateFunc: generateMain }
                    };
                    
                    if (fileMapping[fileKey]) {
                        const mapping = fileMapping[fileKey];
                        
                        // Try to display existing file first
                        const displayed = await displayExistingFile(mapping.path, mapping.isMarkdown);
                        
                        // If file doesn't exist, generate it
                        if (!displayed) {
                            await mapping.generateFunc();
                        }
                        
                        return;
                    }
                }
                
                // Show loading
                document.getElementById('contentBody').innerHTML = '<div class="loading">Loading...</div>';
                
                try {
                    const response = await fetch(`/api/file/${fileKey}`);
                    const data = await response.json();
                    
                    const contentBody = document.getElementById('contentBody');
                    
                    if (fileKey.includes('spec')) {
                        // Render markdown
                        contentBody.innerHTML = `<div class="markdown-content">${marked.parse(data.content)}</div>`;
                    } else {
                        // Render Python code with syntax highlighting
                        contentBody.innerHTML = `<pre><code class="language-python">${data.content}</code></pre>`;
                        Prism.highlightAll();
                    }
                } catch (error) {
                    console.error('Error loading file:', error);
                    document.getElementById('contentBody').innerHTML = '<div class="loading">Error loading file</div>';
                }
            });
        });
        
        // Initialize the application
        loadTxtFiles();
        initializeCloseButton();
        
        // Initialize delete button (use event delegation since button gets recreated)
        document.addEventListener('click', function(e) {
            if (e.target && e.target.id === 'deleteButton') {
                deleteCurrentArtifact();
            }
            
            // Handle edit button
            if (e.target && e.target.id === 'editGraph') {
                enterEditMode();
            }
            
            // Handle save button
            if (e.target && e.target.id === 'saveGraph') {
                saveGraphChanges();
            }
            
            // Handle cancel button
            if (e.target && e.target.id === 'cancelEdit') {
                exitEditMode(false);
            }
        });
    </script>
</body>
</html>
